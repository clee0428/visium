PB245 Visium HD (8 Âµm) â€“ Full Spatial-Only Pipeline

Goal:
Unsupervised spatial transcriptomics analysis â†’ biologically annotated compartments â†’ DEGs â†’ figures
No scRNA required

0ï¸âƒ£ Environment
library(Seurat)
library(SeuratObject)
library(ggplot2)
library(dplyr)

1ï¸âƒ£ Load processed Visium HD data (Space Ranger output)

Use Space Ranger binned outputs, not raw FASTQs

seu <- readRDS("PB245_visiumHD_8um_annotated.rds")


Confirm assays:

Assays(seu)
# "Spatial.002um" "Spatial.008um" "Spatial.016um"

2ï¸âƒ£ Set 8 Âµm assay (main analysis resolution)
DefaultAssay(seu) <- "Spatial.008um"


Check data exists:

GetAssayData(seu, layer = "counts")[1:5,1:5]

3ï¸âƒ£ Light QC filtering (remove empty bins)

Critical for cleaner UMAP

seu_qc <- subset(
  seu,
  subset = nCount_Spatial.008um >= 20 & nFeature_Spatial.008um >= 10
)

4ï¸âƒ£ Normalization & dimensionality reduction
seu_qc <- NormalizeData(seu_qc)
seu_qc <- FindVariableFeatures(seu_qc, nfeatures = 2000)
seu_qc <- ScaleData(seu_qc)
seu_qc <- RunPCA(seu_qc, npcs = 30)

5ï¸âƒ£ Clustering & UMAP (spatial-only)
seu_qc <- FindNeighbors(seu_qc, dims = 1:20)
seu_qc <- FindClusters(seu_qc, resolution = 0.4)
seu_qc <- RunUMAP(seu_qc, dims = 1:20)

6ï¸âƒ£ Inspect clusters with marker genes
FeaturePlot(
  seu_qc,
  features = c(
    "EPCAM","KRT19",        # tumour
    "COL1A1","COL3A1",      # stroma
    "PTPRC","LYZ","IGKC"    # immune
  ),
  min.cutoff = "q10",
  max.cutoff = "q90"
)

7ï¸âƒ£ Assign biological identities (manual, robust)

Create cell_identity:

seu_qc$cell_identity <- NA

# Example mapping â€” adjust cluster IDs to your data
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("0","1")] <- "Tumour"
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("2","3","4")] <- "Stroma"
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("5","6")] <- "Immune"
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("7","9")] <- "Macrophage_TAM"


Set identities:

Idents(seu_qc) <- seu_qc$cell_identity


Rename object:

seu_trim <- seu_qc

8ï¸âƒ£ Clean UMAP for presentation (downsampling)
set.seed(1)
n_plot <- min(50000, ncol(seu_trim))
cells_plot <- sample(Cells(seu_trim), n_plot)

p_umap_clean <- DimPlot(
  subset(seu_trim, cells = cells_plot),
  reduction = "umap",
  label = TRUE,
  repel = TRUE,
  pt.size = 0.6
) +
  theme_classic() +
  theme(text = element_text(size = 14))


Save:

ggsave("PB245_clean_umap_biolabels.pdf", p_umap_clean, width = 7, height = 5)

9ï¸âƒ£ Spatial compartment map
p_spatial <- SpatialDimPlot(
  seu_trim,
  group.by = "cell_identity",
  image.alpha = 0.6,
  label = FALSE
)


Save:

ggsave("PB245_spatial_compartment_map.pdf", p_spatial, width = 7, height = 8)

ğŸ”Ÿ Differential expression (spatial-native)
Tumour vs Stroma
deg_ts <- FindMarkers(
  seu_trim,
  ident.1 = "Tumour",
  ident.2 = "Stroma",
  min.pct = 0.25,
  logfc.threshold = 0.25
)

write.csv(deg_ts, "DEG_Tumour_vs_Stroma.csv")

Immune vs TAM
deg_it <- FindMarkers(
  seu_trim,
  ident.1 = "Immune",
  ident.2 = "Macrophage_TAM",
  min.pct = 0.25,
  logfc.threshold = 0.25
)

write.csv(deg_it, "DEG_TAM_vs_Immune.csv")

1ï¸âƒ£1ï¸âƒ£ Marker DotPlot (readable)
genes_show <- c(
  "EPCAM","KRT19",
  "COL1A1","COL3A1",
  "LYZ","PTPRC","IGKC",
  "SPP1","MARCO"
)

p_dot <- DotPlot(
  seu_trim,
  features = genes_show,
  group.by = "cell_identity"
) +
  RotatedAxis()

ggsave("PB245_dotplot_cell_identity.pdf", p_dot, width = 9, height = 4)

1ï¸âƒ£2ï¸âƒ£ Heatmap (downsampled & interpretable)
cells_hm <- sample(Cells(seu_trim), 3000)

seu_hm <- subset(seu_trim, cells = cells_hm)

seu_hm <- ScaleData(seu_hm, features = genes_show)

p_hm <- DoHeatmap(
  seu_hm,
  features = genes_show,
  group.by = "cell_identity"
) + NoLegend()

ggsave("PB245_heatmap_downsampled_readable.pdf", p_hm, width = 10, height = 6)

1ï¸âƒ£3ï¸âƒ£ Save final object (MOST IMPORTANT)
saveRDS(
  seu_trim,
  file = "PB245_visiumHD_8um_annotated.rds"
)


Reload anytime:

seu_trim <- readRDS("PB245_visiumHD_8um_annotated.rds")
