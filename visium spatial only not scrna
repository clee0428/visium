Below is a full, end-to-end Visium HD (PB245) pipeline WITHOUT scRNA, written to match what you actually have (Space Ranger binned_outputs with square_008um, 016um, etc.) and the RAM constraints you hit (no full-graph clustering on 567k bins).

It’s split into: A) Build object, B) HD-safe clustering via sketch + projection, C) Biological annotation, D) DEGs + plots, E) Save/reload.

A) Build / load the Seurat object
Option A1 — If you already have a good saved Seurat object
library(Seurat)
library(ggplot2)
library(dplyr)

seu <- readRDS("/home/lchristine/visium_PB245/PB245_visiumHD_8um_annotated_full.rds")

Option A2 — Create from Space Ranger binned_outputs (recommended if starting fresh)

Your folder is like:
.../outs/binned_outputs/ containing square_008um, square_016um, etc.

library(Seurat)
library(ggplot2)
library(dplyr)

base <- "/home/lchristine/visium/visium_tar/GIMR_GGP_MARPAJ_20250625_Visium/PB245/spaceranger_count_cytassist/PB245/outs/binned_outputs"

# Seurat can read Visium HD bins; depending on Seurat version, use Load10X_Spatial with binning
# If your object already exists, skip this step and load the RDS.
seu <- Load10X_Spatial(
  data.dir = base,
  bin.size = 8   # creates an 8um object if supported
)


If Load10X_Spatial(..., bin.size=8) doesn’t work in your install, don’t force it—use your existing .rds that already contains Spatial.008um.

B) Visium HD-safe clustering (sketch only) + projection
1) Set assay to 8 µm
DefaultAssay(seu) <- "Spatial.008um"
Assays(seu)
Layers(seu[["Spatial.008um"]])

2) Basic QC (optional but good)
VlnPlot(seu, features = c("nCount_Spatial.008um","nFeature_Spatial.008um"), pt.size = 0)

3) Normalize + HVGs (on full object OK)
seu <- NormalizeData(seu)
seu <- FindVariableFeatures(seu, nfeatures = 2000)

4) (Optional but helpful) PCA on FULL with “full” name

This lets us project later without recomputing everything.

seu <- ScaleData(seu, features = VariableFeatures(seu), verbose = FALSE)
seu <- RunPCA(seu, npcs = 30, features = VariableFeatures(seu), reduction.name = "pca.full")

5) Make a sketch (Uniform works in your Seurat; LeverageScore was too slow)
seu <- SketchData(
  seu,
  assay = "Spatial.008um",
  ncells = 30000,        # 30k–50k is typical; keep 30k for stability
  method = "Uniform"
)

6) Cluster ON SKETCH
DefaultAssay(seu) <- "sketch"

seu <- NormalizeData(seu)
seu <- FindVariableFeatures(seu, nfeatures = 2000)
seu <- ScaleData(seu, features = VariableFeatures(seu), verbose = FALSE)
seu <- RunPCA(seu, npcs = 30, features = VariableFeatures(seu))

seu <- FindNeighbors(seu, dims = 1:20, nn.method = "annoy", k.param = 20)
seu <- FindClusters(seu, resolution = 0.4)
seu <- RunUMAP(seu, dims = 1:20)

DimPlot(seu, label = TRUE)   # this is sketch UMAP

7) Project sketch clusters back to ALL 8 µm bins
DefaultAssay(seu) <- "Spatial.008um"

seu <- ProjectData(
  object = seu,
  assay = "Spatial.008um",
  sketched.assay = "sketch",
  sketched.reduction = "pca",
  full.reduction = "pca.full",
  dims = 1:20,
  refdata = list(seurat_clusters = "seurat_clusters")
)

# Check the projected fields exist:
grep("seurat_clusters", colnames(seu@meta.data), value = TRUE)


At this point you have:

seurat_clusters = projected label for each 8 µm bin

seurat_clusters.score = confidence

C) Plot spatial clusters (robust way) + annotate biology
1) Make a plotting object (avoid Seurat plotting edge cases)
cells_ok <- Cells(seu)[!is.na(seu$seurat_clusters)]
seu_plot <- subset(seu, cells = cells_ok)

seu_plot$seurat_clusters <- factor(as.character(seu_plot$seurat_clusters))
Idents(seu_plot) <- seu_plot$seurat_clusters

2) Spatial plot of numeric clusters
DefaultAssay(seu_plot) <- "Spatial.008um"
p_clusters <- SpatialDimPlot(seu_plot, image.alpha = 0.6, label = FALSE)
p_clusters

3) Define biological mapping (edit if you change your mind)

Example based on your work:

tumour_clusters <- c("10","0")
stroma_clusters <- c("1")
immune_clusters <- c("2","3")
tam_clusters    <- c("7","9")

4) Create biological labels
seu$cell_identity <- NA
seu$cell_identity[seu$seurat_clusters %in% tumour_clusters] <- "Tumour"
seu$cell_identity[seu$seurat_clusters %in% stroma_clusters] <- "Stroma"
seu$cell_identity[seu$seurat_clusters %in% immune_clusters] <- "Immune"
seu$cell_identity[seu$seurat_clusters %in% tam_clusters]    <- "Macrophage_TAM"

seu$cell_identity <- factor(seu$cell_identity, levels = c("Tumour","Stroma","Immune","Macrophage_TAM"))

5) Plot labelled compartments on tissue
cells_ok <- Cells(seu)[!is.na(seu$cell_identity)]
seu_lab <- subset(seu, cells = cells_ok)

Idents(seu_lab) <- seu_lab$cell_identity

p_comp <- SpatialDimPlot(seu_lab, image.alpha = 0.6, label = FALSE)
p_comp

D) DEGs + interpretable plots (DotPlot + average heatmap)
1) Subset for DE (optional: keep only high-confidence projected bins)
seu_id <- seu_lab
# optional confidence filter:
# seu_id <- subset(seu_lab, subset = seurat_clusters.score > 0.5)

DefaultAssay(seu_id) <- "Spatial.008um"
Idents(seu_id) <- "cell_identity"

2) DEGs by compartment
markers_all <- FindAllMarkers(
  seu_id,
  only.pos = TRUE,
  min.pct = 0.25,
  logfc.threshold = 0.25
)

write.csv(markers_all, "PB245_DEGs_by_cell_identity.csv", row.names = FALSE)

3) DotPlot (best for readability) + save
library(ggplot2)

genes_show <- c(
  "EPCAM","KRT19","MMP7","CEACAM6",
  "COL1A1","COL1A2","COL3A1","DCN","LUM",
  "PTPRC","IGKC",
  "LYZ","SPP1","LGALS3","MARCO"
)
genes_show <- intersect(genes_show, rownames(seu_id))

p_dot <- DotPlot(seu_id, features = genes_show, group.by = "cell_identity") +
  RotatedAxis()

p_dot
ggsave("PB245_dotplot_cell_identity.pdf", p_dot, width = 9, height = 4.5)
ggsave("PB245_dotplot_cell_identity.png", p_dot, width = 9, height = 4.5, dpi = 300)

E) Save / reload (checkpointing)
Save everything important
saveRDS(seu, "PB245_visiumHD_8um_full_projected.rds")
saveRDS(seu_lab, "PB245_visiumHD_8um_labelled_onlybins.rds")
saveRDS(seu_id, "PB245_visiumHD_8um_DEsubset.rds")
save.image("PB245_visiumHD_without_scRNA_session.RData")

Reload later
library(Seurat)
seu <- readRDS("PB245_visiumHD_8um_full_projected.rds")
