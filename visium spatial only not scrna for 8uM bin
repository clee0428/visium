PB245 Visium HD (8 Âµm) â€“ Full Spatial-Only Pipeline

Goal:
Unsupervised spatial transcriptomics analysis â†’ biologically annotated compartments â†’ DEGs â†’ figures
No scRNA required

0ï¸âƒ£ Environment
library(Seurat)
library(SeuratObject)
library(ggplot2)
library(dplyr)

1ï¸âƒ£ Load processed Visium HD data (Space Ranger output)

Use Space Ranger binned outputs, not raw FASTQs

seu <- readRDS("PB245_visiumHD_8um_annotated.rds")


Confirm assays:

Assays(seu)
# "Spatial.002um" "Spatial.008um" "Spatial.016um"

2ï¸âƒ£ Set 8 Âµm assay (main analysis resolution)
DefaultAssay(seu) <- "Spatial.008um"


Check data exists:

GetAssayData(seu, layer = "counts")[1:5,1:5]

3ï¸âƒ£ Light QC filtering (remove empty bins)

Critical for cleaner UMAP

seu_qc <- subset(
  seu,
  subset = nCount_Spatial.008um >= 20 & nFeature_Spatial.008um >= 10
)

4ï¸âƒ£ Normalization & dimensionality reduction
seu_qc <- NormalizeData(seu_qc)
seu_qc <- FindVariableFeatures(seu_qc, nfeatures = 2000)
seu_qc <- ScaleData(seu_qc)
seu_qc <- RunPCA(seu_qc, npcs = 30)

5ï¸âƒ£ Clustering & UMAP (spatial-only)
seu_qc <- FindNeighbors(seu_qc, dims = 1:20)
seu_qc <- FindClusters(seu_qc, resolution = 0.4)
seu_qc <- RunUMAP(seu_qc, dims = 1:20)

6ï¸âƒ£ Inspect clusters with marker genes
FeaturePlot(
  seu_qc,
  features = c(
    "EPCAM","KRT19",        # tumour
    "COL1A1","COL3A1",      # stroma
    "PTPRC","LYZ","IGKC"    # immune
  ),
  min.cutoff = "q10",
  max.cutoff = "q90"
)

7ï¸âƒ£ Assign biological identities (manual, robust)

Create cell_identity:

seu_qc$cell_identity <- NA

# Example mapping â€” adjust cluster IDs to your data
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("0","1")] <- "Tumour"
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("2","3","4")] <- "Stroma"
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("5","6")] <- "Immune"
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("7","9")] <- "Macrophage_TAM"


Set identities:

Idents(seu_qc) <- seu_qc$cell_identity


Rename object:

seu_trim <- seu_qc

8ï¸âƒ£ Clean UMAP for presentation (downsampling)
set.seed(1)
n_plot <- min(50000, ncol(seu_trim))
cells_plot <- sample(Cells(seu_trim), n_plot)

p_umap_clean <- DimPlot(
  subset(seu_trim, cells = cells_plot),
  reduction = "umap",
  label = TRUE,
  repel = TRUE,
  pt.size = 0.6
) +
  theme_classic() +
  theme(text = element_text(size = 14))


Save:

ggsave("PB245_clean_umap_biolabels.pdf", p_umap_clean, width = 7, height = 5)

9ï¸âƒ£ Spatial compartment map
p_spatial <- SpatialDimPlot(
  seu_trim,
  group.by = "cell_identity",
  image.alpha = 0.6,
  label = FALSE
)


Save:

ggsave("PB245_spatial_compartment_map.pdf", p_spatial, width = 7, height = 8)

ğŸ”Ÿ Differential expression (spatial-native)
Tumour vs Stroma
deg_ts <- FindMarkers(
  seu_trim,
  ident.1 = "Tumour",
  ident.2 = "Stroma",
  min.pct = 0.25,
  logfc.threshold = 0.25
)

write.csv(deg_ts, "DEG_Tumour_vs_Stroma.csv")

Immune vs TAM
deg_it <- FindMarkers(
  seu_trim,
  ident.1 = "Immune",
  ident.2 = "Macrophage_TAM",
  min.pct = 0.25,
  logfc.threshold = 0.25
)

write.csv(deg_it, "DEG_TAM_vs_Immune.csv")

1ï¸âƒ£1ï¸âƒ£ Marker DotPlot (readable)
genes_show <- c(
  "EPCAM","KRT19",
  "COL1A1","COL3A1",
  "LYZ","PTPRC","IGKC",
  "SPP1","MARCO"
)

p_dot <- DotPlot(
  seu_trim,
  features = genes_show,
  group.by = "cell_identity"
) +
  RotatedAxis()

ggsave("PB245_dotplot_cell_identity.pdf", p_dot, width = 9, height = 4)

1ï¸âƒ£2ï¸âƒ£ Heatmap (downsampled & interpretable)
cells_hm <- sample(Cells(seu_trim), 3000)

seu_hm <- subset(seu_trim, cells = cells_hm)

seu_hm <- ScaleData(seu_hm, features = genes_show)

p_hm <- DoHeatmap(
  seu_hm,
  features = genes_show,
  group.by = "cell_identity"
) + NoLegend()

ggsave("PB245_heatmap_downsampled_readable.pdf", p_hm, width = 10, height = 6)

1ï¸âƒ£3ï¸âƒ£ Save final object (MOST IMPORTANT)
saveRDS(
  seu_trim,
  file = "PB245_visiumHD_8um_annotated.rds"
)


Reload anytime:

seu_trim <- readRDS("PB245_visiumHD_8um_annotated.rds")


ADditional things

1) Save two objects: â€œanalysisâ€ and â€œpresentationâ€

Downsampling is only for plotting. Keep DEGs on the full seu_trim.

# Save the full analysis object
saveRDS(seu_trim, "PB245_visiumHD_8um_ANALYSIS.rds")

# Save a lightweight plotting object (optional)
saveRDS(seu_hm, "PB245_visiumHD_8um_PLOT_HEATMAP_3k.rds")

2) Add a QC report + plots (so you can justify filtering)

At minimum: nCount, nFeature, percent.mt.

DefaultAssay(seu) <- "Spatial.008um"
seu[["percent.mt"]] <- PercentageFeatureSet(seu, pattern = "^MT-")

VlnPlot(seu, features = c("nCount_Spatial.008um","nFeature_Spatial.008um","percent.mt"),
        pt.size = 0.01, ncol = 3)

FeatureScatter(seu, feature1 = "nCount_Spatial.008um", feature2 = "nFeature_Spatial.008um")


Then choose cutoffs (your current ones are fine as a starting point).

3) Make DEGs consistent and faster: use PrepSCTFindMarkers only if SCT; otherwise do this

For LogNormalize, itâ€™s fineâ€”just set ident and keep assays consistent:

DefaultAssay(seu_trim) <- "Spatial.008um"
Idents(seu_trim) <- "cell_identity"


Optional: run DE with a fixed test:

deg_ts <- FindMarkers(seu_trim, ident.1="Tumour", ident.2="Stroma",
                      test.use="wilcox", min.pct=0.25, logfc.threshold=0.25)

4) Add â€œpseudo-bulk per regionâ€ summaries (this makes plots meaningful)

UMAP is just an embedding. You want average expression per compartment:

avg_expr <- AverageExpression(seu_trim, group.by = "cell_identity", assays = "Spatial.008um")
write.csv(avg_expr$Spatial.008um, "PB245_avgexpr_by_cell_identity.csv")

5) Spatially variable genes (SVGs) â€“ but use a method that wonâ€™t allocate 700 GB

Moranâ€™s I on 8Âµm can explode. Use a lighter method / subset features:

DefaultAssay(seu_trim) <- "Spatial.008um"
seu_trim <- FindSpatiallyVariableFeatures(
  seu_trim,
  selection.method = "markvariogram",   # usually lighter than moransi
  features = VariableFeatures(seu_trim)[1:1000]
)
svg <- head(SpatiallyVariableFeatures(seu_trim), 12)
p_svg <- SpatialFeaturePlot(seu_trim, features = svg, alpha = c(0.1, 1))
ggsave("PB245_SVG_markvariogram_top12.pdf", p_svg, width=12, height=8)


(If you really want Moranâ€™s I, do it on downsampled cells or smaller feature sets.)

6) Add composition plots (what you asked for): counts + percentages barplots
library(dplyr); library(ggplot2)

df_comp <- as.data.frame(table(seu_trim$cell_identity))
colnames(df_comp) <- c("cell_identity","n")
df_comp <- df_comp %>% mutate(pct = 100*n/sum(n))

p_counts <- ggplot(df_comp, aes(x=cell_identity, y=n)) +
  geom_col() + theme_classic() + labs(x=NULL, y="Bins")

p_pct <- ggplot(df_comp, aes(x=cell_identity, y=pct)) +
  geom_col() + theme_classic() + labs(x=NULL, y="% of bins") +
  scale_y_continuous(limits=c(0,100))

ggsave("PB245_cell_identity_counts.pdf", p_counts, width=5, height=4)
ggsave("PB245_cell_identity_percent.pdf", p_pct, width=5, height=4)

7) Export a â€œresults folderâ€ structure + session info (reproducibility)

At the end of the script:

dir.create("PB245_visiumHD_spatial_only/results", recursive=TRUE, showWarnings=FALSE)
dir.create("PB245_visiumHD_spatial_only/figures", recursive=TRUE, showWarnings=FALSE)

writeLines(capture.output(sessionInfo()),
           "PB245_visiumHD_spatial_only/sessionInfo.txt")

8) (Optional but recommended) Separate Immune into T/B/Myeloid properly

Right now TAM has 33 binsâ€”DE vs Immune will be unstable. Consider:

keep TAM for mapping only

do DE immune subtype after reclustering only immune bins

seu_imm <- subset(seu_trim, subset = cell_identity %in% c("Immune","Macrophage_TAM"))
seu_imm <- FindVariableFeatures(seu_imm)
seu_imm <- ScaleData(seu_imm)
seu_imm <- RunPCA(seu_imm)
seu_imm <- FindNeighbors(seu_imm, dims=1:20)
seu_imm <- FindClusters(seu_imm, resolution=0.6)
seu_imm <- RunUMAP(seu_imm, dims=1:20)



16uM  analysis

0) Set paths + create 16 Âµm project folders
base_dir <- "/home/lchristine/PB245_visiumHD_spatial_only_no_scRNA"
dir.create(base_dir, showWarnings = FALSE)

dir.create(file.path(base_dir, "16um_analysis"), showWarnings = FALSE)
dir.create(file.path(base_dir, "16um_analysis/01_seurat_objects"), showWarnings = FALSE)
dir.create(file.path(base_dir, "16um_analysis/02_figures"), showWarnings = FALSE)
dir.create(file.path(base_dir, "16um_analysis/03_tables"), showWarnings = FALSE)

bin16_dir <- "/home/lchristine/visium/visium_tar/GIMR_GGP_MARPAJ_20250625_Visium/PB245/spaceranger_count_cytassist/PB245/outs/binned_outputs/square_016um"

1) Load 16 Âµm bins as a NEW Seurat object
library(Seurat)

seu_16um <- Load10X_Spatial(
  data.dir = bin16_dir,
  filename = "filtered_feature_bc_matrix.h5",
  assay = "Spatial"
)

seu_16um


If you get an error about images/scale factors, tell me the exact message â€” but this usually works from square_016um.

2) QC + normalisation + PCA/UMAP (standard Seurat)
# QC metrics
seu_16um[["percent.mt"]] <- PercentageFeatureSet(seu_16um, pattern = "^MT-")

# quick look (optional)
# VlnPlot(seu_16um, features = c("nCount_Spatial","nFeature_Spatial","percent.mt"), pt.size = 0.1, ncol = 3)

# Filtering (tweak if needed)
seu_16um <- subset(
  seu_16um,
  subset = nCount_Spatial > 50 & nFeature_Spatial > 50 & percent.mt < 25
)

# Normalisation + HVGs + scaling
seu_16um <- NormalizeData(seu_16um)
seu_16um <- FindVariableFeatures(seu_16um, selection.method = "vst", nfeatures = 2000)
seu_16um <- ScaleData(seu_16um)

# PCA/UMAP + neighbours + clusters
seu_16um <- RunPCA(seu_16um, npcs = 30, verbose = FALSE)
seu_16um <- FindNeighbors(seu_16um, dims = 1:30)
seu_16um <- FindClusters(seu_16um, resolution = 0.5)
seu_16um <- RunUMAP(seu_16um, dims = 1:30)

3) Quick plots (overview) + save
library(ggplot2)

p_umap16 <- DimPlot(seu_16um, reduction = "umap", label = TRUE) +
  theme_classic() + ggtitle("PB245 VisiumHD 16 Âµm: UMAP")

p_sp16 <- SpatialDimPlot(seu_16um, label = TRUE, label.size = 3) +
  ggtitle("PB245 VisiumHD 16 Âµm: Spatial clusters")

ggsave(file.path(base_dir, "16um_analysis/02_figures/PB245_16um_UMAP.png"),
       p_umap16, width = 7, height = 5, dpi = 300)

ggsave(file.path(base_dir, "16um_analysis/02_figures/PB245_16um_SpatialClusters.png"),
       p_sp16, width = 7, height = 6, dpi = 300)

4) Save the Seurat object (so you can continue Monday)
saveRDS(
  seu_16um,
  file.path(base_dir, "16um_analysis/01_seurat_objects/seu_16um.rds")
)
