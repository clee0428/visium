PB245 Visium HD (8 ¬µm) ‚Äì Full Spatial-Only Pipeline

Goal:
Unsupervised spatial transcriptomics analysis ‚Üí biologically annotated compartments ‚Üí DEGs ‚Üí figures
No scRNA required

0Ô∏è‚É£ Environment
library(Seurat)
library(SeuratObject)
library(ggplot2)
library(dplyr)

1Ô∏è‚É£ Load processed Visium HD data (Space Ranger output)

Use Space Ranger binned outputs, not raw FASTQs

seu <- readRDS("PB245_visiumHD_8um_annotated.rds")


Confirm assays:

Assays(seu)
# "Spatial.002um" "Spatial.008um" "Spatial.016um"

2Ô∏è‚É£ Set 8 ¬µm assay (main analysis resolution)
DefaultAssay(seu) <- "Spatial.008um"


Check data exists:

GetAssayData(seu, layer = "counts")[1:5,1:5]

3Ô∏è‚É£ Light QC filtering (remove empty bins)

Critical for cleaner UMAP

seu_qc <- subset(
  seu,
  subset = nCount_Spatial.008um >= 20 & nFeature_Spatial.008um >= 10
)

4Ô∏è‚É£ Normalization & dimensionality reduction
seu_qc <- NormalizeData(seu_qc)
seu_qc <- FindVariableFeatures(seu_qc, nfeatures = 2000)
seu_qc <- ScaleData(seu_qc)
seu_qc <- RunPCA(seu_qc, npcs = 30)

5Ô∏è‚É£ Clustering & UMAP (spatial-only)
seu_qc <- FindNeighbors(seu_qc, dims = 1:20)
seu_qc <- FindClusters(seu_qc, resolution = 0.4)
seu_qc <- RunUMAP(seu_qc, dims = 1:20)

6Ô∏è‚É£ Inspect clusters with marker genes
FeaturePlot(
  seu_qc,
  features = c(
    "EPCAM","KRT19",        # tumour
    "COL1A1","COL3A1",      # stroma
    "PTPRC","LYZ","IGKC"    # immune
  ),
  min.cutoff = "q10",
  max.cutoff = "q90"
)

7Ô∏è‚É£ Assign biological identities (manual, robust)

Create cell_identity:

seu_qc$cell_identity <- NA

# Example mapping ‚Äî adjust cluster IDs to your data
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("0","1")] <- "Tumour"
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("2","3","4")] <- "Stroma"
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("5","6")] <- "Immune"
seu_qc$cell_identity[seu_qc$seurat_clusters %in% c("7","9")] <- "Macrophage_TAM"


Set identities:

Idents(seu_qc) <- seu_qc$cell_identity


Rename object:

seu_trim <- seu_qc

8Ô∏è‚É£ Clean UMAP for presentation (downsampling)
set.seed(1)
n_plot <- min(50000, ncol(seu_trim))
cells_plot <- sample(Cells(seu_trim), n_plot)

p_umap_clean <- DimPlot(
  subset(seu_trim, cells = cells_plot),
  reduction = "umap",
  label = TRUE,
  repel = TRUE,
  pt.size = 0.6
) +
  theme_classic() +
  theme(text = element_text(size = 14))


Save:

ggsave("PB245_clean_umap_biolabels.pdf", p_umap_clean, width = 7, height = 5)

9Ô∏è‚É£ Spatial compartment map
p_spatial <- SpatialDimPlot(
  seu_trim,
  group.by = "cell_identity",
  image.alpha = 0.6,
  label = FALSE
)


Save:

ggsave("PB245_spatial_compartment_map.pdf", p_spatial, width = 7, height = 8)

üîü Differential expression (spatial-native)
Tumour vs Stroma
deg_ts <- FindMarkers(
  seu_trim,
  ident.1 = "Tumour",
  ident.2 = "Stroma",
  min.pct = 0.25,
  logfc.threshold = 0.25
)

write.csv(deg_ts, "DEG_Tumour_vs_Stroma.csv")

Immune vs TAM
deg_it <- FindMarkers(
  seu_trim,
  ident.1 = "Immune",
  ident.2 = "Macrophage_TAM",
  min.pct = 0.25,
  logfc.threshold = 0.25
)

write.csv(deg_it, "DEG_TAM_vs_Immune.csv")

1Ô∏è‚É£1Ô∏è‚É£ Marker DotPlot (readable)
genes_show <- c(
  "EPCAM","KRT19",
  "COL1A1","COL3A1",
  "LYZ","PTPRC","IGKC",
  "SPP1","MARCO"
)

p_dot <- DotPlot(
  seu_trim,
  features = genes_show,
  group.by = "cell_identity"
) +
  RotatedAxis()

ggsave("PB245_dotplot_cell_identity.pdf", p_dot, width = 9, height = 4)

1Ô∏è‚É£2Ô∏è‚É£ Heatmap (downsampled & interpretable)
cells_hm <- sample(Cells(seu_trim), 3000)

seu_hm <- subset(seu_trim, cells = cells_hm)

seu_hm <- ScaleData(seu_hm, features = genes_show)

p_hm <- DoHeatmap(
  seu_hm,
  features = genes_show,
  group.by = "cell_identity"
) + NoLegend()

ggsave("PB245_heatmap_downsampled_readable.pdf", p_hm, width = 10, height = 6)

1Ô∏è‚É£3Ô∏è‚É£ Save final object (MOST IMPORTANT)
saveRDS(
  seu_trim,
  file = "PB245_visiumHD_8um_annotated.rds"
)


Reload anytime:

seu_trim <- readRDS("PB245_visiumHD_8um_annotated.rds")


ADditional things

1) Save two objects: ‚Äúanalysis‚Äù and ‚Äúpresentation‚Äù

Downsampling is only for plotting. Keep DEGs on the full seu_trim.

# Save the full analysis object
saveRDS(seu_trim, "PB245_visiumHD_8um_ANALYSIS.rds")

# Save a lightweight plotting object (optional)
saveRDS(seu_hm, "PB245_visiumHD_8um_PLOT_HEATMAP_3k.rds")

2) Add a QC report + plots (so you can justify filtering)

At minimum: nCount, nFeature, percent.mt.

DefaultAssay(seu) <- "Spatial.008um"
seu[["percent.mt"]] <- PercentageFeatureSet(seu, pattern = "^MT-")

VlnPlot(seu, features = c("nCount_Spatial.008um","nFeature_Spatial.008um","percent.mt"),
        pt.size = 0.01, ncol = 3)

FeatureScatter(seu, feature1 = "nCount_Spatial.008um", feature2 = "nFeature_Spatial.008um")


Then choose cutoffs (your current ones are fine as a starting point).

3) Make DEGs consistent and faster: use PrepSCTFindMarkers only if SCT; otherwise do this

For LogNormalize, it‚Äôs fine‚Äîjust set ident and keep assays consistent:

DefaultAssay(seu_trim) <- "Spatial.008um"
Idents(seu_trim) <- "cell_identity"


Optional: run DE with a fixed test:

deg_ts <- FindMarkers(seu_trim, ident.1="Tumour", ident.2="Stroma",
                      test.use="wilcox", min.pct=0.25, logfc.threshold=0.25)

4) Add ‚Äúpseudo-bulk per region‚Äù summaries (this makes plots meaningful)

UMAP is just an embedding. You want average expression per compartment:

avg_expr <- AverageExpression(seu_trim, group.by = "cell_identity", assays = "Spatial.008um")
write.csv(avg_expr$Spatial.008um, "PB245_avgexpr_by_cell_identity.csv")

5) Spatially variable genes (SVGs) ‚Äì but use a method that won‚Äôt allocate 700 GB

Moran‚Äôs I on 8¬µm can explode. Use a lighter method / subset features:

DefaultAssay(seu_trim) <- "Spatial.008um"
seu_trim <- FindSpatiallyVariableFeatures(
  seu_trim,
  selection.method = "markvariogram",   # usually lighter than moransi
  features = VariableFeatures(seu_trim)[1:1000]
)
svg <- head(SpatiallyVariableFeatures(seu_trim), 12)
p_svg <- SpatialFeaturePlot(seu_trim, features = svg, alpha = c(0.1, 1))
ggsave("PB245_SVG_markvariogram_top12.pdf", p_svg, width=12, height=8)


(If you really want Moran‚Äôs I, do it on downsampled cells or smaller feature sets.)

6) Add composition plots (what you asked for): counts + percentages barplots
library(dplyr); library(ggplot2)

df_comp <- as.data.frame(table(seu_trim$cell_identity))
colnames(df_comp) <- c("cell_identity","n")
df_comp <- df_comp %>% mutate(pct = 100*n/sum(n))

p_counts <- ggplot(df_comp, aes(x=cell_identity, y=n)) +
  geom_col() + theme_classic() + labs(x=NULL, y="Bins")

p_pct <- ggplot(df_comp, aes(x=cell_identity, y=pct)) +
  geom_col() + theme_classic() + labs(x=NULL, y="% of bins") +
  scale_y_continuous(limits=c(0,100))

ggsave("PB245_cell_identity_counts.pdf", p_counts, width=5, height=4)
ggsave("PB245_cell_identity_percent.pdf", p_pct, width=5, height=4)

7) Export a ‚Äúresults folder‚Äù structure + session info (reproducibility)

At the end of the script:

dir.create("PB245_visiumHD_spatial_only/results", recursive=TRUE, showWarnings=FALSE)
dir.create("PB245_visiumHD_spatial_only/figures", recursive=TRUE, showWarnings=FALSE)

writeLines(capture.output(sessionInfo()),
           "PB245_visiumHD_spatial_only/sessionInfo.txt")

8) (Optional but recommended) Separate Immune into T/B/Myeloid properly

Right now TAM has 33 bins‚ÄîDE vs Immune will be unstable. Consider:

keep TAM for mapping only

do DE immune subtype after reclustering only immune bins

seu_imm <- subset(seu_trim, subset = cell_identity %in% c("Immune","Macrophage_TAM"))
seu_imm <- FindVariableFeatures(seu_imm)
seu_imm <- ScaleData(seu_imm)
seu_imm <- RunPCA(seu_imm)
seu_imm <- FindNeighbors(seu_imm, dims=1:20)
seu_imm <- FindClusters(seu_imm, resolution=0.6)
seu_imm <- RunUMAP(seu_imm, dims=1:20)



16uM  analysis

0) Set paths + create 16 ¬µm project folders
base_dir <- "/home/lchristine/PB245_visiumHD_spatial_only_no_scRNA"
dir.create(base_dir, showWarnings = FALSE)

dir.create(file.path(base_dir, "16um_analysis"), showWarnings = FALSE)
dir.create(file.path(base_dir, "16um_analysis/01_seurat_objects"), showWarnings = FALSE)
dir.create(file.path(base_dir, "16um_analysis/02_figures"), showWarnings = FALSE)
dir.create(file.path(base_dir, "16um_analysis/03_tables"), showWarnings = FALSE)

bin16_dir <- "/home/lchristine/visium/visium_tar/GIMR_GGP_MARPAJ_20250625_Visium/PB245/spaceranger_count_cytassist/PB245/outs/binned_outputs/square_016um"

1) Load 16 ¬µm bins as a NEW Seurat object
library(Seurat)

seu_16um <- Load10X_Spatial(
  data.dir = bin16_dir,
  filename = "filtered_feature_bc_matrix.h5",
  assay = "Spatial"
)

seu_16um


If you get an error about images/scale factors, tell me the exact message ‚Äî but this usually works from square_016um.

############################################################
## PB245 VisiumHD 16 ¬µm analysis (Seurat v5 safe)
## QC -> filtering -> normalize/scale -> PCA -> UMAP -> clustering
## + saves plots + objects + metadata
############################################################

suppressPackageStartupMessages({
  library(Seurat)
  library(SeuratObject)
  library(ggplot2)
  library(dplyr)
})

## ---------------------------
## 0) Paths + folders
## ---------------------------

# Input: 10x binned_outputs folder for 16um
data_16um <- "/home/lchristine/visium/visium_tar/GIMR_GGP_MARPAJ_20250625_Visium/PB245/spaceranger_count_cytassist/PB245/outs/binned_outputs/square_016um/"

# Project root (as you requested)
proj_root <- "/home/lchristine/PB245_visium/16uM_analysis/PB245_visiumHD_spatial_only_no_scRNA"

obj_dir  <- file.path(proj_root, "01_seurat_objects")
fig_dir  <- file.path(proj_root, "02_figures")
tab_dir  <- file.path(proj_root, "03_tables")
log_dir  <- file.path(proj_root, "04_logs")

dir.create(obj_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(tab_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(log_dir, recursive = TRUE, showWarnings = FALSE)

# Optional: write session info for reproducibility
sink(file.path(log_dir, "sessionInfo_16um.txt"))
print(sessionInfo())
sink()

## ---------------------------
## 1) Load 16 ¬µm data
## ---------------------------
# NOTE: Load10X_Spatial works for Visium-style outputs.
# Your folder has:
#   filtered_feature_bc_matrix.h5
#   spatial/
# so this should work.

seu_16um <- Load10X_Spatial(
  data.dir = data_16um,
  filename = "filtered_feature_bc_matrix.h5",
  slice = "slice1.016um"
)

# Ensure assay name is Spatial
DefaultAssay(seu_16um) <- "Spatial"

# IMPORTANT for Seurat v5 / your earlier errors:
# create a "data" layer so plotting functions don't crash trying to find it.
seu_16um <- NormalizeData(seu_16um, assay = "Spatial", normalization.method = "LogNormalize", scale.factor = 1e4, verbose = FALSE)

# Quick object check
print(seu_16um)

## ---------------------------
## 2) QC metrics
## ---------------------------
# percent.mt (may be 0 for many bins; that's OK)
seu_16um[["percent.mt"]] <- PercentageFeatureSet(seu_16um, pattern = "^MT-")

# Save metadata snapshot before filtering
write.csv(
  seu_16um@meta.data,
  file = file.path(tab_dir, "PB245_16um_metadata_pre_filter.csv"),
  quote = FALSE
)

# QC plots (FeatureScatter + violin) - avoid functions that crash in your environment
p_sc1 <- FeatureScatter(seu_16um, feature1 = "nCount_Spatial", feature2 = "nFeature_Spatial") +
  theme_classic() + ggtitle("PB245 16um: nCount vs nFeature")
p_sc2 <- FeatureScatter(seu_16um, feature1 = "nCount_Spatial", feature2 = "percent.mt") +
  theme_classic() + ggtitle("PB245 16um: nCount vs percent.mt")

ggsave(file.path(fig_dir, "PB245_16um_QC_scatter_nCount_nFeature.png"), p_sc1, width = 6, height = 5, dpi = 300)
ggsave(file.path(fig_dir, "PB245_16um_QC_scatter_nCount_percentMT.png"), p_sc2, width = 6, height = 5, dpi = 300)
ggsave(file.path(fig_dir, "PB245_16um_QC_scatter_nCount_nFeature.pdf"), p_sc1, width = 6, height = 5, device = cairo_pdf)
ggsave(file.path(fig_dir, "PB245_16um_QC_scatter_nCount_percentMT.pdf"), p_sc2, width = 6, height = 5, device = cairo_pdf)

# If VlnPlot works in your session, keep it; if it crashes again, comment out.
p_vln <- VlnPlot(
  seu_16um,
  features = c("nCount_Spatial", "nFeature_Spatial", "percent.mt"),
  pt.size = 0
) + NoLegend() + ggtitle("PB245 16um QC (pre-filter)")

ggsave(file.path(fig_dir, "PB245_16um_QC_violin_pre_filter.png"), p_vln, width = 10, height = 4, dpi = 300)
ggsave(file.path(fig_dir, "PB245_16um_QC_violin_pre_filter.pdf"), p_vln, width = 10, height = 4, device = cairo_pdf)

## ---------------------------
## 3) Filtering (light, spatial-appropriate)
## ---------------------------
# These are the thresholds you already tested (keeps ~94k bins).
seu_16um <- subset(
  seu_16um,
  subset =
    nCount_Spatial >= 20 &
    nFeature_Spatial >= 10 &
    (is.na(percent.mt) | percent.mt <= 35)
)

# Save metadata after filtering
write.csv(
  seu_16um@meta.data,
  file = file.path(tab_dir, "PB245_16um_metadata_post_filter.csv"),
  quote = FALSE
)

# Quick summary table
qc_summary <- data.frame(
  n_bins = ncol(seu_16um),
  nCount_min = min(seu_16um$nCount_Spatial),
  nCount_median = median(seu_16um$nCount_Spatial),
  nCount_mean = mean(seu_16um$nCount_Spatial),
  nCount_max = max(seu_16um$nCount_Spatial),
  nFeature_min = min(seu_16um$nFeature_Spatial),
  nFeature_median = median(seu_16um$nFeature_Spatial),
  nFeature_mean = mean(seu_16um$nFeature_Spatial),
  nFeature_max = max(seu_16um$nFeature_Spatial)
)
write.csv(qc_summary, file.path(tab_dir, "PB245_16um_QC_summary.csv"), row.names = FALSE, quote = FALSE)

## ---------------------------
## 4) Normalization + HVGs + scaling
## ---------------------------
# (We already created a data layer above, but redo is fine after filtering)
seu_16um <- NormalizeData(seu_16um, assay = "Spatial", verbose = FALSE)

seu_16um <- FindVariableFeatures(
  seu_16um,
  assay = "Spatial",
  selection.method = "vst",
  nfeatures = 2000,
  verbose = FALSE
)

# Scale only HVGs (faster, safer)
seu_16um <- ScaleData(
  seu_16um,
  assay = "Spatial",
  features = VariableFeatures(seu_16um),
  verbose = FALSE
)

## ---------------------------
## 5) PCA
## ---------------------------
seu_16um <- RunPCA(
  seu_16um,
  assay = "Spatial",
  features = VariableFeatures(seu_16um),
  npcs = 30,
  verbose = FALSE
)

p_elbow <- ElbowPlot(seu_16um, ndims = 30) + theme_classic() + ggtitle("PB245 16um ElbowPlot")
ggsave(file.path(fig_dir, "PB245_16um_ElbowPlot.png"), p_elbow, width = 5.5, height = 4.5, dpi = 300)
ggsave(file.path(fig_dir, "PB245_16um_ElbowPlot.pdf"), p_elbow, width = 5.5, height = 4.5, device = cairo_pdf)

## ---------------------------
## 6) Neighbours / clustering / UMAP
## ---------------------------
# Use dims 1:10 by default (matches your elbow plot interpretation)
dims_use <- 1:10

seu_16um <- FindNeighbors(seu_16um, dims = dims_use, verbose = FALSE)
seu_16um <- FindClusters(seu_16um, resolution = 0.4, verbose = FALSE)

seu_16um <- RunUMAP(seu_16um, dims = dims_use, verbose = FALSE)

# UMAP plot
p_umap <- DimPlot(seu_16um, reduction = "umap", label = TRUE, repel = TRUE) +
  theme_classic() + ggtitle("PB245 VisiumHD (16 ¬µm) UMAP (clusters)")

ggsave(file.path(fig_dir, "PB245_16um_UMAP_clusters.png"), p_umap, width = 7, height = 5, dpi = 300)
ggsave(file.path(fig_dir, "PB245_16um_UMAP_clusters.pdf"), p_umap, width = 7, height = 5, device = cairo_pdf)

# Spatial cluster plot
p_spatial <- SpatialDimPlot(seu_16um, group.by = "seurat_clusters", label = TRUE, label.size = 3) +
  ggtitle("PB245 VisiumHD (16 ¬µm) Spatial clusters")

ggsave(file.path(fig_dir, "PB245_16um_Spatial_clusters.png"), p_spatial, width = 7, height = 6, dpi = 300)
ggsave(file.path(fig_dir, "PB245_16um_Spatial_clusters.pdf"), p_spatial, width = 7, height = 6, device = cairo_pdf)

# Save cluster counts
clust_counts <- as.data.frame(table(Idents(seu_16um)))
colnames(clust_counts) <- c("seurat_clusters", "n_bins")
write.csv(clust_counts, file.path(tab_dir, "PB245_16um_cluster_counts.csv"), row.names = FALSE, quote = FALSE)

## ---------------------------
## 7) Quick marker genes per cluster (optional but useful)
## ---------------------------
# This can take a bit, but is manageable at 16um
DefaultAssay(seu_16um) <- "Spatial"
Idents(seu_16um) <- "seurat_clusters"

markers_16um <- FindAllMarkers(
  seu_16um,
  only.pos = TRUE,
  min.pct = 0.1,
  logfc.threshold = 0.25,
  test.use = "wilcox"
)

write.csv(markers_16um, file.path(tab_dir, "PB245_16um_FindAllMarkers.csv"), row.names = FALSE, quote = FALSE)

# Top 10 per cluster table
top10 <- markers_16um %>%
  group_by(cluster) %>%
  slice_max(order_by = avg_log2FC, n = 10, with_ties = FALSE) %>%
  ungroup()
write.csv(top10, file.path(tab_dir, "PB245_16um_top10_markers_per_cluster.csv"), row.names = FALSE, quote = FALSE)

## ---------------------------
## 8) Save objects
## ---------------------------
saveRDS(seu_16um, file.path(obj_dir, "PB245_seu_16um.rds"))

# Save a full session (optional, big)
save.image(file.path(obj_dir, "PB245_16um_session.RData"))

message("‚úÖ DONE. Outputs written to: ", proj_root)
message("   Seurat object: ", file.path(obj_dir, "PB245_seu_16um.rds"))
message("   Figures:       ", fig_dir)
message("   Tables:        ", tab_dir)
